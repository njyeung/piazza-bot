services:
  # Cassandra cluster (3 nodes)
  db-1:
    platform: linux/amd64
    build:
      context: .
      dockerfile: cassandra/Dockerfile.cassandra
    container_name: db-1
    ports:
      - "9042:9042"
    deploy:
      resources:
        limits:
          memory: 1G
    restart: unless-stopped

  db-2:
    platform: linux/amd64
    build:
      context: .
      dockerfile: cassandra/Dockerfile.cassandra
    container_name: db-2
    depends_on:
      - db-1
    deploy:
      resources:
        limits:
          memory: 1G
    restart: unless-stopped

  db-3:
    platform: linux/amd64
    build:
      context: .
      dockerfile: cassandra/Dockerfile.cassandra
    container_name: db-3
    depends_on:
      - db-1
    deploy:
      resources:
        limits:
          memory: 1G
    restart: unless-stopped

  db_init:
    build:
      context: .
      dockerfile: cassandra/Dockerfile.init
    container_name: db-init
    depends_on:
      - db-1
      - db-2
      - db-3
    environment:
      - CASSANDRA_HOSTS=db-1,db-2,db-3
      - CASSANDRA_KEYSPACE=transcript_db
    restart: on-failure:3

  # web crawler
  redis:
    image: redis:7-alpine
    container_name: crawler-redis
    command: ["redis-server", "--save", "", "--appendonly", "no"]  # disable persistence
    tmpfs:
      - /data
    ports:
      - "6379:6379"
    
  fetcher:
    platform: linux/amd64
    build:
      context: .
      dockerfile: crawler/Dockerfile.fetcher
    depends_on:
      redis:
        condition: service_started
      db_init:
        condition: service_completed_successfully
      kafka_init:
        condition: service_completed_successfully
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_QUEUE=frontier
      - CASSANDRA_HOSTS=db-1,db-2,db-3
      - CASSANDRA_KEYSPACE=transcript_db
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_TOPIC=transcript-events
    restart: unless-stopped
    deploy:
      replicas: 3

  watcher:
    platform: linux/amd64
    build:
      context: .
      dockerfile: crawler/Dockerfile.watcher
    container_name: crawler-watcher
    depends_on:
      redis:
        condition: service_started
      db_init:
        condition: service_completed_successfully
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_QUEUE=frontier
      - REDIS_SEEN_SET=seen
      - CASSANDRA_HOSTS=db-1,db-2,db-3
      - CASSANDRA_KEYSPACE=transcript_db
    restart: unless-stopped

  # Kafka message broker
  kafka:
    platform: linux/amd64
    build:
      context: .
      dockerfile: kafka/Dockerfile.kafka
    container_name: kafka-broker
    ports:
      - "9092:9092"
    environment:
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
    deploy:
      resources:
        limits:
          memory: 1G
    restart: unless-stopped

  kafka_init:
    build:
      context: .
      dockerfile: kafka/Dockerfile.init
    container_name: kafka-init
    depends_on:
      - kafka
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_TOPIC=transcript-events

  # Transcript processor with GPU support
  processor:
    platform: linux/amd64
    build:
      context: .
      dockerfile: processor/Dockerfile.processor
    container_name: processor
    depends_on:
      db_init:
        condition: service_completed_successfully
      kafka_init:
        condition: service_completed_successfully
    environment:
      - CASSANDRA_HOSTS=db-1,db-2,db-3
      - CASSANDRA_KEYSPACE=transcript_db
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_TOPIC=transcript-events
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped

  # Qwen3 4b LLM service
  llm:
    platform: linux/amd64
    build:
      context: .
      dockerfile: llm/Dockerfile
    container_name: qwen3-llm
    ports:
      - "11434:11434"
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped
    volumes:
      - ollama-data:/root/.ollama

volumes:
  ollama-data: