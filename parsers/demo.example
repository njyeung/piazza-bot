# CLASS_NAME: CS544
# PROFESSOR: Tyler
# SEMESTER: FALL25
# PIAZZA_NETWORK_ID: merk8zm4in1ib
# PIAZZA_EMAIL: Your piazza email
# PIAZZA_PASSWORD: Your piazza password

"""
CS544 Fall 2025 parser for Tyler Caraza-Harter's course schedule.

Extracts Kaltura lecture gallery links from the course schedule page.
"""

import json
from selenium import webdriver
from selenium.webdriver.chrome.service import Service as ChromeService
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC


def main():
    """
    Parse CS544 schedule page and print lecture Kaltura gallery links to stdout.
    """
    schedule_url = "https://tyler.caraza-harter.com/cs544/f25/schedule.html"

    chrome_options = webdriver.ChromeOptions()
    chrome_options.binary_location = "/usr/local/bin/chrome"

    # Run headless in Docker
    chrome_options.add_argument('--headless=new')
    chrome_options.add_argument('--no-sandbox')
    chrome_options.add_argument('--disable-dev-shm-usage')
    chrome_options.add_argument('--disable-gpu')

    service = ChromeService(executable_path="/usr/local/bin/chromedriver")
    driver = webdriver.Chrome(service=service, options=chrome_options)


    try:
        driver.get(schedule_url)

        # Wait for page to load
        WebDriverWait(driver, 3).until(
            EC.presence_of_element_located((By.TAG_NAME, "a"))
        )

        # Find all lecture divs (col-md-4 my-3)
        lecture_divs = driver.find_elements(By.CLASS_NAME, "col-md-4")

        for div in lecture_divs:
            # Find the lecture link (Watch: <a>Lecture</a>)
            links = div.find_elements(By.TAG_NAME, "a")
            lecture_link = None

            for link in links:
                if "lecture" in link.text.lower():
                    lecture_link = link
                    break

            if lecture_link:
                href = lecture_link.get_attribute("href")

                # Find the title from <span id="lec-XX-title">
                try:
                    title_span = div.find_element(By.CSS_SELECTOR, "span[id$='-title']")
                    lecture_title = title_span.text.strip()
                except:
                    # Fallback if title span not found
                    lecture_title = "Unknown"

                if href:
                    lecture_data = {
                        "class_name": "CS544",
                        "professor": "Tyler",
                        "semester": "FALL25",
                        "url": href,
                        "lecture_title": lecture_title
                    }
                    print(json.dumps(lecture_data))

    except Exception as e:
        print(f"Error fetching lecture links: {e}", file=__import__('sys').stderr)
        raise

    finally:
        driver.quit()


if __name__ == "__main__":
    main()
